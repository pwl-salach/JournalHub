# Android
# Build your Android project with Gradle.
# Add steps that test, sign, and distribute the APK, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/android

trigger:
- main

pool:
  vmImage: 'macos-latest'

parameters:
  - name: devices
    type: object
    default:
      - pixel_3a
      - pixel_4_xl
      - nexus_6

  - name: apis
    type: object
    default:
      - 30

steps:
#- task: Gradle@2
#  inputs:
#    workingDirectory: ''
#    gradleWrapperFile: 'gradlew'
#    gradleOptions: '-Xmx3072m'
#    publishJUnitResults: false
#    testResultsFiles: '**/TEST-*.xml'
#    tasks: 'assembleDebug'
#    env:
#    JAVA_HOME: $(JAVA_HOME_17_X64)
#
#- task: PublishPipelineArtifact@1
#  inputs:
#    targetPath: '$(Build.SourcesDirectory)/app/build/outputs/apk'
#    artifact: 'Apk'
#    publishLocation: 'pipeline'

- ${{ each api in parameters.apis }}:
  - script: echo "y" | $ANDROID_HOME/tools/bin/sdkmanager --install 'system-images;android-${{ api }};google_apis;x86_64'
    displayName: Install Android-${{ api }} API

  - script: $ANDROID_HOME/tools/bin/avdmanager list device

  - ${{ each device in parameters.devices }}:
    - script: |
        $ANDROID_HOME/tools/bin/avdmanager create avd --name ${{ device }}_${{ api }} --device "${{ device }}" --package 'system-images;android-${{ api }};google_apis;x86_64' --abi x86_64
      displayName: 'Create ${{ device }}_${{ api }} Emulator'

    - script: $ANDROID_HOME/emulator/emulator -avd ${{ device }}_${{ api }} -no-snapshot -wipe-data -no-window
      displayName: 'Start ${{ device }}_${{ api }} Emulator'

    - script: ./gradlew --rerun-tasks appiumTests:test -Ddevice=${{ device }}_${{ api }}
      displayName: 'Run Appium tests'